{% extends "base.html" %}
{% block content %}

<style>
  h2 {
    text-align: center;
    margin-bottom: 1.5rem;
    color: #333;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-top: 1rem;
  }

  .card {
    background: #fff;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s ease;
  }

  .card:hover {
    transform: translateY(-3px);
  }

  .card h3 {
    margin-bottom: 1rem;
    color: #444;
    border-bottom: 2px solid #eee;
    padding-bottom: 0.4rem;
  }

  .card h4 {
    margin-top: 1.2rem;
    margin-bottom: 0.5rem;
    color: #555;
    font-size: 1rem;
  }

  ul {
    list-style: disc;
    padding-left: 1.2rem;
    font-size: 0.9rem;
    color: #555;
  }

  ul li {
    margin-bottom: 0.4rem;
  }

  canvas {
    width: 100% !important;
    height: 280px !important;
    margin-bottom: 1rem;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<h2>Dashboard</h2>

<div class="dashboard-grid">
  <div class="card">
    <h3>Training History</h3>
    <canvas id="accChart"></canvas>
    <canvas id="lossChart"></canvas>
  </div>

  <div class="card">
    <h3>Class Distribution (your uploads)</h3>
    <canvas id="classChart"></canvas>
    <h4>Recent uploads</h4>
    <ul>
      {% for r in recent %}
      <li>{{ r.time }} — {{ r.class }} ({{ "%.2f"|format(r.confidence) }}%)</li>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
  // --- 1. Safely pass training history from Flask to JS ---
  const history = JSON.parse('{{ training_history | tojson | safe }}');

  if (history && history.epochs && history.epochs.length > 0) {
      // Accuracy chart
      const accCtx = document.getElementById('accChart').getContext('2d');
      new Chart(accCtx, {
          type: 'line',
          data: {
              labels: history.epochs,
              datasets: [
                  { label: 'Train Acc', data: history.accuracy, borderColor: 'blue', fill:false },
                  { label: 'Val Acc', data: history.val_accuracy, borderColor: 'green', fill:false }
              ]
          },
          options: { responsive: true }
      });

      // Loss chart
      const lossCtx = document.getElementById('lossChart').getContext('2d');
      new Chart(lossCtx, {
          type: 'line',
          data: {
              labels: history.epochs,
              datasets: [
                  { label: 'Train Loss', data: history.loss, borderColor: 'red', fill:false },
                  { label: 'Val Loss', data: history.val_loss, borderColor: 'orange', fill:false }
              ]
          },
          options: { responsive: true }
      });
  } else {
      console.warn("Training history is empty or invalid.");
  }

  // --- 2. User class distribution (dynamic pie chart) ---
  fetch('/api/user_stats')
    .then(r => r.json())
    .then(data => {
      const counts = data.class_counts || {};
      const labels = Object.keys(counts);
      const values = labels.map(l => counts[l]);

      if (labels.length > 0) {
          // ✅ Dynamic colors based on number of labels
          const colors = labels.map((_, i) => `hsl(${i*360/labels.length},70%,60%)`);

          const classCtx = document.getElementById('classChart').getContext('2d');
          new Chart(classCtx, {
              type: 'pie',
              data: {
                  labels: labels,
                  datasets: [{ data: values, backgroundColor: colors }]
              },
              options: { responsive: true }
          });
      }
    })
    .catch(err => console.error("Error fetching class stats:", err));
</script>
{% endblock %}
